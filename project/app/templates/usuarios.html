{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'app/styles.css' %}">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario</title>
</head>

<body>
    
    <!--Navigation bar-->
    <div class="header">
        <nav>
            <ul>
                <li><a href="/home">Calendario</a></li>
                <li><a href="/habitaciones" >Habitaciones</a></li>
                <li><a href="/usuarios" class="active">Usuarios</a></li>
            </ul>
        </nav>
    </div>

    
    <!--Main content area-->
    <div class="main-content">


        <!--Data table-->
        <div id="tabla-habitaciones">
            <table class="tabla-habitaciones">
                <thead>
                    <tr>
                        <th>Nombres</th>
                        <th>Apellidos</th>
                        <th>Tipo de documento</th>
                        <th>Numero de documento</th>
                        <th>Llegada</th>
                        <th>Salida</th>
                        <th>Info. Adicional</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas se generarán dinámicamente con JavaScript -->
            </table>
        </div>

        <!--Tool Sidebar-->
        <div class="tool-sidebar">
            <ul>
                <li><button>Agregar usuario</button></li>
                <li><button id="editar-usuario-btn">Editar usuario</button></li>
            </ul>
        </div>
    </div>

    <!-- Modal para ver info de usuario -->
    <div id="modal-info" class="modal-info" style="display:none;">
        <div class="modal-content">
            <button id="close-modal" class="close-modal-btn">✕</button>
            <h2>Información del usuario</h2>
            <div id="modal-data"></div>
            <div id="modal-qr" style="margin: 20px 0;"></div>
            <button class="send-email-btn">Enviar al correo</button>
        </div>
    </div>

    <div id="modal-editar-usuario" class="modal-info" style="display:none;">
        <div class="modal-content">
            <button id="cerrar-editar-usuario" class="close-modal-btn">✕</button>
            <h2>Editar usuario</h2>
            <form id="form-editar-usuario">
                <div style="display: flex; gap: 32px; flex-wrap: wrap;">
                    <!-- Left column: Editar información de usuario -->
                    <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 8px;">
                        <h3 style="margin-top:0;">Información de usuario</h3>
                        <label>Nombre:</label>
                        <input type="text" id="editar-nombre" required>

                        <label>Apellido:</label>
                        <input type="text" id="editar-apellido" required>

                        <label>Tipo de documento:</label>
                        <input type="text" id="editar-tipo-documento">

                        <label>Número de documento:</label>
                        <input type="text" id="editar-documento" required>
                        
                        <label>Estado:</label>
                        <select id="editar-estado">
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>

                    </div>
                    <!-- Right column: Asignar habitación -->
                    <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 8px;">
                        <h3 style="margin-top:0;">Asignar habitación</h3>
                        <label>Zona:</label>
                        <select id="editar-zona">
                            <!-- Opciones de zonas se llenarán dinámicamente si aplica -->
                        </select>

                        <label>Habitación:</label>
                        <select id="editar-habitacion"></select>

                        <label>Litera:</label>
                        <select id="editar-litera"></select>

                        <label>Llegada:</label>
                        <input type="date" id="editar-llegada">

                        <label>Salida:</label>
                        <input type="date" id="editar-salida">
                    </div>
                </div>
                <!-- Buttons row -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 32px;">
                    <button type="button" onclick="document.getElementById('modal-editar-usuario').style.display='none';">Cancelar</button>
                    <button type="submit" style="margin-left:auto;">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!--Animations and functions-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        let usuarioSeleccionado = null;

        // Modal logic
        function mostrarModalInfo(usuario) {
            usuarioSeleccionado = usuario;
            const modal = document.getElementById('modal-info');
            const modalData = document.getElementById('modal-data');
            const modalQR = document.getElementById('modal-qr');
            modal.style.display = 'flex';

            modalData.innerHTML = `
                <div style="margin-bottom:16px;">
                    <strong>Zona:</strong> ${usuario.zona}<br>
                    <strong>Habitación:</strong> ${usuario.habitacion}<br>
                    <strong>Litera:</strong> ${usuario.habitacion}_${usuario.litera}<br>
                </div>
            `;

            modalQR.innerHTML = "";
            // Info para QR
            const qrInfo = `
                Documento: ${usuario.documento}
            `;
            new QRCode(modalQR, {
                text: qrInfo,
                width: 160,
                height: 160,
                colorDark : "#1D1D1D",
                colorLight : "#fff",
                correctLevel : QRCode.CorrectLevel.L
            });
        }

        function seleccionarUsuarioInfo(btn, usuario) {
            // Reset all seleccionar buttons
            document.querySelectorAll(".tabla-habitaciones button.seleccionar-btn").forEach(b => {
                b.style.backgroundColor = "#1D1D1D";
                b.style.color = "#fff";
            });
            // Highlight the clicked button
            btn.style.backgroundColor = "#537854";
            btn.style.color = "#fff";

            usuarioSeleccionado = usuario;
            console.log("Usuario seleccionado:", usuario);
        }

        // Cerrar modal
        document.getElementById('close-modal').onclick = function() {
            document.getElementById('modal-info').style.display = 'none';
        };

        // Cargar usuarios desde el backend y mostrarlos en la tabla
        function cargarUsuarios() {
            fetch('/api/usuarios/listar/')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector(".tabla-habitaciones tbody");
                    tbody.innerHTML = "";

                    data.usuarios.forEach(usuario => {
                        const fila = document.createElement("tr");

                        fila.innerHTML = `
                            <td>${usuario.nombre || "-"}</td>
                            <td>${usuario.apellido || "-"}</td>
                            <td>${usuario.tipo_documento || "-"}</td>
                            <td>${usuario.documento || "-"}</td>
                            <td>${usuario.llegada || "-"}</td>
                            <td>${usuario.salida || "-"}</td>
                            <td><button onclick='mostrarModalInfo(${JSON.stringify(usuario)})'>Ver más</button><button class="seleccionar-btn" onclick='seleccionarUsuarioInfo(this, ${JSON.stringify(usuario)})'>Seleccionar</button></td>
                            <td>${usuario.estado ? "Activo" : "Inactivo"}</td>
                        `;

                        tbody.appendChild(fila);
                    });
                })
                .catch(error => {
                    console.error("Error al cargar usuarios:", error);
                });
        }

        // Llamar al cargar la página
        window.onload = cargarUsuarios;

        document.getElementById('editar-usuario-btn').addEventListener('click', () => {
            if (!usuarioSeleccionado) {
                alert("Primero haz clic en 'Seleccionar' de un usuario.");
                return;
            }

            const modal = document.getElementById('modal-editar-usuario');
            modal.style.display = 'flex';

            // Rellenar campos de usuario
            document.getElementById('editar-nombre').value = usuarioSeleccionado.nombre || "";
            document.getElementById('editar-apellido').value = usuarioSeleccionado.apellido || "";
            document.getElementById('editar-tipo-documento').value = usuarioSeleccionado.tipo_documento || "";
            document.getElementById('editar-documento').value = usuarioSeleccionado.documento || "";
            document.getElementById('editar-llegada').value = usuarioSeleccionado.llegada || "";
            document.getElementById('editar-salida').value = usuarioSeleccionado.salida || "";
            document.getElementById('editar-estado').value = usuarioSeleccionado.estado ? "Activo" : "Inactivo";

            // Cargar zonas
            fetch('/api/zonas/listar/')
                .then(response => response.json())
                .then(data => {
                    const zonaSelect = document.getElementById('editar-zona');
                    zonaSelect.innerHTML = '<option value="">Seleccione</option>';

                    (data.zonas || []).forEach(z => {
                        const nombreZona = z.nombre || z; // depende del formato de tu API
                        const option = document.createElement('option');
                        option.value = nombreZona;
                        option.textContent = nombreZona;
                        zonaSelect.appendChild(option);
                    });

                    // Seleccionar zona del usuario y cargar habitaciones
                    if (usuarioSeleccionado.zona) {
                        zonaSelect.value = usuarioSeleccionado.zona;
                        cargarHabitaciones(usuarioSeleccionado.zona, usuarioSeleccionado.habitacion);
                    }
                });

            // Listener para cambio de zona
            document.getElementById('editar-zona').onchange = function () {
                const zona = this.value;
                if (zona) {
                    cargarHabitaciones(zona);
                } else {
                    document.getElementById('editar-habitacion').innerHTML = '<option value="">Seleccione</option>';
                    document.getElementById('editar-litera').innerHTML = '<option value="">Seleccione</option>';
                }
            };
        });

        // Función para cargar habitaciones según zona
        function cargarHabitaciones(zona, habitacionPreseleccionada = "") {
            fetch(`/api/habitaciones/listar/?zona=${zona}`)
                .then(response => response.json())
                .then(data => {
                    const habitacionSelect = document.getElementById('editar-habitacion');
                    habitacionSelect.innerHTML = '<option value="">Seleccione</option>';

                    (data.habitaciones || []).forEach(h => {
                        // Si backend no manda "ocupada", no filtrar
                        if (h.ocupada === undefined || !h.ocupada) {
                            const option = document.createElement('option');
                            option.value = h.nomenclatura;
                            option.textContent = h.nomenclatura;
                            habitacionSelect.appendChild(option);
                        }
                    });

                    if (habitacionPreseleccionada) {
                        habitacionSelect.value = habitacionPreseleccionada;
                        cargarLiteras(habitacionPreseleccionada, usuarioSeleccionado.litera);
                    }

                    habitacionSelect.onchange = function () {
                        const hab = this.value;
                        if (hab) {
                            cargarLiteras(hab);
                        } else {
                            document.getElementById('editar-litera').innerHTML = '<option value="">Seleccione</option>';
                        }
                    };
                });
        }

        // Función para cargar literas según habitación
        function cargarLiteras(habitacion, literaPreseleccionada = "") {
            fetch(`/api/literas/listar/${habitacion}/`)
                .then(response => response.json())
                .then(data => {
                    const literaSelect = document.getElementById('editar-litera');
                    literaSelect.innerHTML = '<option value="">Seleccione</option>';

                    (data.literas || []).forEach(l => {
                        if (l.ocupada === undefined || !l.ocupada) {
                            const option = document.createElement('option');
                            option.value = l.codigo;
                            option.textContent = l.codigo;
                            literaSelect.appendChild(option);
                        }
                    });

                    if (literaPreseleccionada) {
                        literaSelect.value = literaPreseleccionada;
                    }
                });
        }

        document.getElementById('cerrar-editar-usuario').onclick = function () {
            document.getElementById('modal-editar-usuario').style.display = 'none';
        };

        document.getElementById('form-editar-usuario').addEventListener('submit', function (e) {
            e.preventDefault();
            const payload = {
                nombre: document.getElementById('editar-nombre').value,
                apellido: document.getElementById('editar-apellido').value,
                tipo_documento: document.getElementById('editar-tipo-documento').value,
                documento: document.getElementById('editar-documento').value,
                llegada: document.getElementById('editar-llegada').value,
                salida: document.getElementById('editar-salida').value,
                habitacion: document.getElementById('editar-habitacion').value,
                litera: document.getElementById('editar-litera').value,
                estado: document.getElementById('editar-estado').value === "Activo"
            };

            fetch(`/api/usuarios/editar/${usuarioSeleccionado.id}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Usuario actualizado");
                    document.getElementById('modal-editar-usuario').style.display = 'none';
                    cargarUsuarios();
                    location.reload();
                } else {
                    alert("Error al actualizar");
                }
            });
        });
    </script>
</body>
</html>