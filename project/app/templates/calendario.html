{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'app/styles.css' %}">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario</title>
    <style>
        .user-menu {
            position: absolute;
            top: 10px;
            right: 20px;
            z-index: 1000;
        }

        #menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        #dropdown-menu {
            position: fixed;
            top: 0;
            right: -250px;
            width: 200px;
            height: 100vh;
            background-color: #1D1D1D;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
            transition: right 0.3s ease;
        }

        #dropdown-menu.open {
            right: 0;
        }

        #dropdown-menu a,
        #dropdown-menu button {
            padding: 15px;
            text-align: left;
            text-decoration: none;
            color: white;
            background: none;
            border: none;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
        }

        #dropdown-menu a:hover,
        #dropdown-menu button:hover {
            background-color: #2c2c2c;
        }
    </style>
</head>

<body>
    
    <!--Navigation bar-->
    <div class="header">
        <nav>
            <ul>
                <li><a href="/home" class="active">Calendario</a></li>
                <li><a href="/habitaciones" >Habitaciones</a></li>
                <li><a href="/usuarios">Usuarios</a></li>
            </ul>
        </nav>
        <div class="user-menu">
            <button id="menu-toggle"><span id="menu-icon">☰</span></button>
        </div>
        <div id="dropdown-menu">
            <a href="#">Perfil</a>
            <form method="post" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" name="cerrar_sesion">Cerrar sesión</button>
            </form>
        </div>
    </div>
    
    <!--Toolbar-->
    <div class="toolbar">
        <button id="filter">
            <svg viewBox="0 0 24 24">
                <path d="M3 5h18M6 10h12M10 15h4" stroke="white" stroke-width="2" stroke-linecap="round" fill="none"/>
            </svg>
            Filtros
        </button>
        <div class="search-container">
            <svg viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="7" stroke="#4F4F4F" stroke-width="2" fill="none"/>
                <line x1="16" y1="16" x2="21" y2="21" stroke="#4F4F4F" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="text" id="search" placeholder="Buscar...">
        </div>
        <button id="gocastillo">Castillo</button>
        <button id="gorestaurante">Restaurante</button>
        <button id="gopiso">Piso</button>
        <button id="gocvilanova">Vilanova</button>
    </div>

    <!--Navigation month-->
    <div class="navigation-month">
        <nav>
            <ul id="month-list">
                <li><a href="#" onclick="showMonth('enero')">Enero</a></li>
                <li><a href="#" onclick="showMonth('febrero')">Febrero</a></li>
                <li><a href="#" onclick="showMonth('marzo')">Marzo</a></li>
                <li><a href="#" onclick="showMonth('abril')">Abril</a></li>
                <li><a href="#" onclick="showMonth('mayo')">Mayo</a></li>
                <li><a href="#" onclick="showMonth('junio')">Junio</a></li>
                <li><a href="#" onclick="showMonth('julio')">Julio</a></li>
                <li><a href="#" onclick="showMonth('agosto')">Agosto</a></li>
                <li><a href="#" onclick="showMonth('septiembre')">Septiembre</a></li>
                <li><a href="#" onclick="showMonth('octubre')">Octubre</a></li>
                <li><a href="#" onclick="showMonth('noviembre')">Noviembre</a></li>
                <li><a href="#" onclick="showMonth('diciembre')">Diciembre</a></li>
            </ul>
        </nav>
    </div>


    <!--Data table-->
    <div id="tabla-mes"></div>

    <!--Animations and functions-->
    <script>


        function showMonth(mesId) {
            // Oculta todos los meses
            document.querySelectorAll('.mes').forEach(function(div) {
                div.style.display = 'none';
            });
            // Muestra el mes seleccionado
            document.getElementById(mesId).style.display = 'block';
        }

        document.querySelectorAll('.toolbar button:not(#filter)').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.toolbar button:not(#filter)').forEach(b => b.classList.remove('active-btn'));
                this.classList.add('active-btn');
            });
        });

        // Selecciona el botón "Castillo" al cargar la página
        window.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.toolbar button:not(#filter)').forEach(b => b.classList.remove('active-btn'));
            const castilloBtn = document.getElementById('gocastillo');
            if (castilloBtn) castilloBtn.classList.add('active-btn');
        });

        // Cambia el botón activo al hacer click
        document.querySelectorAll('.toolbar button:not(#filter)').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.toolbar button:not(#filter)').forEach(b => b.classList.remove('active-btn'));
                this.classList.add('active-btn');
            });
        });

        document.querySelectorAll('.navigation-month nav ul li a').forEach(link => {
            link.addEventListener('click', function(e) {
                document.querySelectorAll('.navigation-month nav ul li a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });
        

        // Devuelve el número de días del mes, considerando años bisiestos
        function diasEnMes(mes, anio) {
            return new Date(anio, mes, 0).getDate();
        }

        // Genera la tabla para el mes seleccionado
        function renderTablaMes(mesNombre, zonaActual, searchText = "") {
            const meses = [
                "enero", "febrero", "marzo", "abril", "mayo", "junio",
                "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
            ];
            const mesIndex = meses.indexOf(mesNombre.toLowerCase());
            const anio = 2025;
            const dias = diasEnMes(mesIndex + 1, anio);

            // Habitaciones y usuarios por zona (deberán ser cargados dinámicamente)
            let habitaciones = [];  // Deberán ser cargadas dinámicamente
            let usuariosZona = [];  // Deberán ser cargados dinámicamente

            // Filtra usuarios por búsqueda
            if (searchText) {
                usuariosZona = usuariosZona.filter(u =>
                    u.nombre.toLowerCase().includes(searchText) ||
                    u.apellido.toLowerCase().includes(searchText) ||
                    u.habitacion.toLowerCase().includes(searchText)
                );

                // Si el texto de búsqueda coincide con algún código de habitación, filtra habitaciones
                const habFiltradas = habitaciones.filter(hab =>
                    hab.toLowerCase().includes(searchText)
                );
                if (habFiltradas.length > 0) {
                    habitaciones = habFiltradas;
                }
            }

            let tabla = '<table><thead><tr>';
            tabla += '<th>Habitaciones</th>';
            for (let d = 1; d <= dias; d++) {
                tabla += `<th>${d}</th>`;
            }
            tabla += '</tr></thead><tbody>';

            habitaciones.forEach(hab => {
                tabla += `<tr><td>${hab}</td>`;
                let d = 1;
                // Extrae código y número de litera
                const [codigo, litera] = hab.split('_');
                const reservas = usuariosZona.filter(u => u.habitacion === codigo && String(u.litera) === litera);
                while (d <= dias) {
                    const reserva = reservas.find(u => {
                        const fechaIn = new Date(u.llegada);
                        const fechaOut = new Date(u.salida);
                        const fechaActual = new Date(anio, mesIndex, d);
                        return (
                            fechaActual >= fechaIn &&
                            fechaActual <= fechaOut &&
                            fechaActual.getMonth() === mesIndex
                        );
                    });

                    if (reserva) {
                        const fechaIn = new Date(reserva.llegada);
                        const fechaOut = new Date(reserva.salida);
                        const start = (fechaIn.getMonth() === mesIndex) ? fechaIn.getDate() : 1;
                        const end = (fechaOut.getMonth() === mesIndex) ? fechaOut.getDate() : dias;
                        const colspan = end - d + 1;

                        tabla += `<td colspan="${colspan}">
                            <div class="reserva-usuario">
                                ${reserva.nombre}
                            </div>
                        </td>`;
                        d = end + 1;
                    } else {
                        tabla += `<td></td>`;
                        d++;
                    }
                }
                tabla += '</tr>';
            });

            tabla += '</tbody></table>';
            document.getElementById('tabla-mes').innerHTML = tabla;
        }

        // Cambia el mes y la clase activa al hacer click en un mes
        document.querySelectorAll('.navigation-month nav ul li a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.navigation-month nav ul li a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                renderTablaMes(this.textContent.trim().toLowerCase());
            });
        });

        // Marca el mes actual como activo al cargar
        window.addEventListener('DOMContentLoaded', function() {
            const meses = [
                "enero", "febrero", "marzo", "abril", "mayo", "junio",
                "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
            ];  
            const mesActual = new Date().getMonth(); // 0-11
            const mesNombre = meses[mesActual];

            renderTablaMes(mesNombre, zonaActual);

            document.querySelectorAll('.navigation-month nav ul li a').forEach(link => {
                if (link.textContent.trim().toLowerCase() === mesNombre) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });

        document.querySelectorAll('.navigation-month nav ul li a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.navigation-month nav ul li a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                renderTablaMes(this.textContent.trim().toLowerCase(), zonaActual);
            });
        });


        // Control de zonas
        let zonaActual = "Castillo"; // Valor inicial

        document.querySelectorAll('.toolbar button:not(#filter)').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.toolbar button:not(#filter)').forEach(b => b.classList.remove('active-btn'));
                this.classList.add('active-btn');
                zonaActual = this.textContent.trim();
                // Obtén el mes activo actual
                const mesActivo = document.querySelector('.navigation-month nav ul li a.active');
                const mesNombre = mesActivo ? mesActivo.textContent.trim().toLowerCase() : "enero";
                renderTablaMes(mesNombre, zonaActual);
            });
        });

        // Filtrado por búsqueda
        document.getElementById('search').addEventListener('input', function() {
            const searchText = this.value.trim().toLowerCase();
            // Obtén el mes y zona actuales
            const mesActivo = document.querySelector('.navigation-month nav ul li a.active');
            const mesNombre = mesActivo ? mesActivo.textContent.trim().toLowerCase() : "enero";
            renderTablaMes(mesNombre, zonaActual, searchText);
        });

    const menuToggle = document.getElementById('menu-toggle');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const menuIcon = document.getElementById('menu-icon');

    menuToggle.addEventListener('click', function () {
        dropdownMenu.classList.toggle('open');
        const isOpen = dropdownMenu.classList.contains('open');
        menuIcon.textContent = isOpen ? '✕' : '☰';
        menuIcon.style.color = isOpen ? 'white' : 'black';
    });

    document.addEventListener('click', function (event) {
        if (!dropdownMenu.contains(event.target) && !menuToggle.contains(event.target)) {
            dropdownMenu.classList.remove('open');
            menuIcon.textContent = '☰';
            menuIcon.style.color = 'black';
        }
    });
</script>
</body>
</html>