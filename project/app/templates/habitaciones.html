{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'app/styles.css' %}">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario</title>
</head>

<body>
    <!--Navigation bar-->
    <div class="header">
        <nav>
            <ul>
                <li><a href="/home">Calendario</a></li>
                <li><a href="/habitaciones" class="active">Habitaciones</a></li>
                <li><a href="/usuarios">Usuarios</a></li>
            </ul>
        </nav>
    </div>

    <!--Main content area-->
    <div class="main-content">
        
        <!--Select Sidebar-->
        <div class="sidebar">
            <ul>
                <li><a href="#">Castillo</a></li>
                <li><a href="#">Restaurante</a></li>
                <li><a href="#">Piso</a></li>
                <li><a href="#">Vilanova</a></li>
            </ul>
        </div>

        <!--Data table-->
        <div id="tabla-habitaciones">
            <table class="tabla-habitaciones">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Estado</th>
                        <th>Tamaño</th>
                        <th>Disponibilidad</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Las filas se generarán dinámicamente con JavaScript -->
                </tbody>
            </table>
        </div>

        <!--Tool Sidebar-->
        <div class="tool-sidebar">
            <ul>
                <li>
                    <input 
                        type="text" 
                        class="tool-search" 
                        placeholder="Buscar"
                    >
                </li>
                <li><button id="abrir-modal-habitacion">Agregar habitación</button></li>
                <li><button id="abrir-modal-editar-habitacion">Editar habitación</button></li>
                <li><button>Organizar por disponibilidad</button></li>
                <li><button>Organizar por estado</button></li>
            </ul>
        </div>
    </div>

    <!-- Formulario de agregar habitacion emergente -->
    <div id="formulario-habitacion" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 24px; border-radius: 12px; width: 300px; position: relative;">
            <h3 style="margin-top: 0;">Agregar Habitación</h3>
            
            <label for="zona-select">Zona:</label>
            <select id="zona-select" style="width: 100%; margin-bottom: 10px;">
                <option value="Castillo">Castillo</option>
                <option value="Restaurante">Restaurante</option>
                <option value="Piso">Piso</option>
                <option value="Vilanova">Vilanova</option>
            </select>

            <label for="tamaño-select">Tamaño (literas):</label>
            <select id="tamaño-select" style="width: 100%; margin-bottom: 20px;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>

            <div style="display: flex; justify-content: space-between;">
                <button onclick="document.getElementById('formulario-habitacion').style.display='none'" style="background: #ccc; border: none; padding: 8px 12px; border-radius: 4px;">Cancelar</button>
                <button id="btn-agregar" style="background: #1D1D1D; color: white; border: none; padding: 8px 12px; border-radius: 4px;">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Formulario de editar habitacion emergente -->
    <div id="formulario-editar-habitacion" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 24px; border-radius: 12px; width: 300px; position: relative;">
            <h3 style="margin-top: 0;">Editar Habitación</h3>
            
            <label for="editar-zona-select">Zona:</label>
            <select id="editar-zona-select" style="width: 100%; margin-bottom: 10px;">
                <option value="">Seleccionar zona</option>
                <option value="Castillo">Castillo</option>
                <option value="Restaurante">Restaurante</option>
                <option value="Piso">Piso</option>
                <option value="Vilanova">Vilanova</option>
            </select>

            <label for="editar-habitacion-select">Habitación:</label>
            <select id="editar-habitacion-select" style="width: 100%; margin-bottom: 10px;">
                <option value="">Seleccionar habitación</option>
            </select>

            <label for="editar-tamaño-select">Tamaño (literas):</label>
            <select id="editar-tamaño-select" style="width: 100%; margin-bottom: 10px;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>

            <label>
                <input type="checkbox" id="editar-desactivada-checkbox" />
                ¿Desactivada?
            </label>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button onclick="document.getElementById('formulario-editar-habitacion').style.display='none'" style="background: #ccc; border: none; padding: 8px 12px; border-radius: 4px;">Cancelar</button>
                <button id="btn-editar" style="background: #1D1D1D; color: white; border: none; padding: 8px 12px; border-radius: 4px;">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Funcionamiento y animaciones de la página-->
    <script>
        
    function renderTablaHabitaciones(zona = "Castillo", habitacionesFiltradas = null) {
        const tabla = document.querySelector("#tabla-habitaciones tbody");
        tabla.innerHTML = "";

        // Usa las habitaciones filtradas si existen, si no usa todas
        let habitaciones = habitacionesFiltradas || [];

        // Ordena: primero activas, luego desactivadas
        habitaciones = [
            ...habitaciones.filter(h => !h.desactivada),
            ...habitaciones.filter(h => h.desactivada)
        ];

        habitaciones.forEach((hab, idx) => {
            const estadoTxt = hab.estado === 1 ? "Disponible" : "No disponible";
            const tamañoTxt = `${hab.tamaño} litera${hab.tamaño > 1 ? "s" : ""}`;
            const disponibilidadTxt = "-";
            const panelId = `panel-${zona}-${hab.nomenclatura}`;

            // Desactivada: agrega clase y deshabilita botones
            const desactivada = hab.desactivada ? "desactivada" : "";
            const disableBtns = hab.desactivada ? "disabled" : "";

            tabla.innerHTML += `
                <tr class="${desactivada}">
                    <td>${hab.nomenclatura}</td>
                    <td>${estadoTxt}</td>
                    <td>${tamañoTxt}</td>
                    <td>${disponibilidadTxt}</td>
                    <td>
                        <button class="visualizar-btn" data-panel="${panelId}" ${disableBtns}>
                            Visualizar
                            <span style="margin-left:6px;">&#9660;</span>
                        </button>
                        <button class="desactivar-btn" data-nomenclatura="${hab.nomenclatura}">
                            ${hab.desactivada ? "Activar" : "Desactivar"}
                        </button>
                    </td>
                </tr>
                <tr class="panel-row" style="display:none;">
                    <td colspan="5">
                        <div id="${panelId}" class="panel-info" style="display:none; background:#F5F5F5; border-radius:12px; padding:16px; margin:8px 0;">
                            <strong>Literas ocupadas:</strong>
                            <table style="width:100%; margin-top:8px;">
                                <thead>
                                    <tr>
                                        <th>Litera</th>
                                        <th>Nombre</th>
                                        <th>Apellido</th>
                                        <th>Documento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Array.from({length: hab.tamaño}, (_, i) => {
                                        return `
                                            <tr>
                                                <td>${hab.nomenclatura}_${i+1}</td>
                                                <td>-</td>
                                                <td>-</td>
                                                <td>-</td>
                                            </tr>
                                        `;
                                    }).join("")}
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
            `;
        });

        // Mostrar/ocultar panel
        document.querySelectorAll('.visualizar-btn').forEach(btn => {
            btn.onclick = function() {
                if (btn.disabled) return;
                const panelId = this.getAttribute('data-panel');
                const panel = document.getElementById(panelId);
                const panelRow = panel.closest('tr.panel-row');
                if (panel.style.display === "none") {
                    panel.style.display = "block";
                    panelRow.style.display = "";
                } else {
                    panel.style.display = "none";
                    panelRow.style.display = "none";
                }
            };
        });
    }

    // Inicializa la tabla con la zona "Castillo"
    function cargarHabitacionesDesdeBackend(zona) {
        fetch(`/api/habitaciones/${zona}/`)
            .then(response => response.json())
            .then(data => {
                renderTablaHabitaciones(zona, data.habitaciones);
            })
            .catch(error => {
                console.error('Error al cargar habitaciones:', error);
            });
    }

    // Inicializa con la zona "Castillo"
    cargarHabitacionesDesdeBackend("Castillo");
    
    // Estructura de almacenamiento para habitaciones añadidas
    document.getElementById("btn-agregar").addEventListener("click", function () {
        const zona = document.getElementById("zona-select").value;
        const tamaño = document.getElementById("tamaño-select").value;

        fetch('/api/habitaciones/crear/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ zona, tamaño })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cargarHabitacionesDesdeBackend(data.zona);
                document.getElementById("formulario-habitacion").style.display = "none";
            } else {
                alert("Error al crear habitación: " + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error en la solicitud.");
        });
    });


    // Cambia la zona al hacer click en la sidebar
    document.querySelectorAll('.sidebar ul li a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.sidebar ul li a').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            cargarHabitacionesDesdeBackend(this.textContent.trim());
        });
    });

    document.querySelector('.tool-search').addEventListener('input', function() {
        const searchText = this.value.trim().toUpperCase();
        // Obtén la zona activa
        const zonaActiva = document.querySelector('.sidebar ul li a.active');
        const zona = zonaActiva ? zonaActiva.textContent.trim() : "Castillo";

        // Filtra habitaciones por código (modificado: no hay habitacionesPorZona, devuelve vacío)
        const habitacionesFiltradas = [];

        renderTablaHabitaciones(zona, habitacionesFiltradas);
    });

    // Mostrar formulario emergente
    document.getElementById('abrir-modal-habitacion').addEventListener('click', () => {
        document.getElementById('formulario-habitacion').style.display = 'flex';
    });

    // Mostrar formulario de editar habitación
    document.querySelector('button#abrir-modal-editar-habitacion').addEventListener('click', () => {
        document.getElementById('formulario-editar-habitacion').style.display = 'flex';
    });

    // Al seleccionar una zona en el modal de edición, cargar habitaciones
    document.getElementById('editar-zona-select').addEventListener('change', function() {
        const zona = this.value;
        const selectHab = document.getElementById('editar-habitacion-select');
        selectHab.innerHTML = '<option value="">Cargando...</option>';

        fetch(`/api/habitaciones/${zona}/`)
            .then(response => response.json())
            .then(data => {
                selectHab.innerHTML = '<option value="">Seleccionar habitación</option>';
                data.habitaciones.forEach(h => {
                    const opt = document.createElement('option');
                    opt.value = h.nomenclatura;
                    opt.textContent = h.nomenclatura;
                    opt.dataset.tamaño = h.tamaño;
                    opt.dataset.desactivada = h.desactivada;
                    selectHab.appendChild(opt);
                });
            });
    });

    // Al seleccionar una habitación, cargar sus datos
    document.getElementById('editar-habitacion-select').addEventListener('change', function() {
        const opt = this.selectedOptions[0];
        if (opt) {
            document.getElementById('editar-tamaño-select').value = opt.dataset.tamaño;
            document.getElementById('editar-desactivada-checkbox').checked = opt.dataset.desactivada === 'true';
        }
    });

    document.getElementById("btn-editar").addEventListener("click", function () {
        const zona = document.getElementById("editar-zona-select").value;
        const nomenclatura = document.getElementById("editar-habitacion-select").value;
        const tamaño = document.getElementById("editar-tamaño-select").value;
        const desactivada = document.getElementById("editar-desactivada-checkbox").checked;

        fetch(`/api/habitaciones/editar/${nomenclatura}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ tamaño, desactivada })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("formulario-editar-habitacion").style.display = "none";
                cargarHabitacionesDesdeBackend(zona);
            } else {
                alert("Error al editar habitación: " + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Error en la solicitud.");
        });
    });
    </script>
</body>
</html>